<html>


    
    <head>
        <title>Generate one-of-a-kind Vehicles</title>
        <meta charset="utf-8" />
        <link
            rel="stylesheet"
            href="https://pyscript.net/latest/pyscript.css"
        />
        <script defer src="https://pyscript.net/latest/pyscript.js"></script>
        <!--<link rel="stylesheet" href="./assets/css/examples.css" />-->
    </head>



    
    <body>

        
        <nav class="navbar" style="background-color: #000000">
            <div class="app-header">
                <a href="">
                    <img src="car.jpg" class="logo" />
                </a>
                <a class="title" href="" style="color: #f0ab3c">KNN avg Generator</a>
            </div>
        </nav>

      
        <div>Type conditions here: </div>
   
 <table>
 
  <tr>
      <td> Folds </td>
     <td> <input type="text" style="border:3px solid #F7730E;" value="3" id="numfolds"/> </td>
      
     <td> Orientation (left/right) </td>
     <td> <input type="text" style="border:3px solid #F7730E;" value="right" id="testInput1"/> </td>

       <td> Color</td>
     <td>   <input type="text" style="border:3px solid #F7730E;" value="blue" id="testInput2"/> </td>

       <td> Vehicle Type (car, truck, van) </td>
     <td>  <input type="text" style="border:3px solid #F7730E;" value="van" id="testInput3"/> </td>

       <td> Configuration (2-door, 4-door, convertible, sliding) </td>
     <td>   <input type="text" style="border:3px solid #F7730E;" value="2-door" id="testInput4"/> </td>
  </tr>
        
       
  <tr>
     <td> Wheel size (small, average, above) </td>
     <td>  <input type="text" style="border:3px solid #F7730E;" value="above" id="testInput5"/> </td>

     <td> Ride Height (lowered, stock, lifted) </td>
     <td>    <input type="text" style="border:3px solid #F7730E;" value="lowered" id="testInput6"/> </td>

     <td> Window tint (none, tint) </td>
     <td>     <input type="text" style="border:3px solid #F7730E;" value="tint" id="testInput7"/> </td>
  </tr> 
 
 </table> 

       
         <button id="get-time" py-click="my_gen_function()"  class="py-button">Generate</button>
                                       
       
        <p id="current-val"></p>
  
        <div id="test-output"></div>

        <div id="pandas-output"></div>
        
        
        <section class="pyscript"> 
            <div id="mpl"></div>

                
                <py-config>
                    packages = [
                      "matplotlib",
                      "pandas",
                    ]
                    plugins = [
                      "https://pyscript.net/latest/plugins/python/py_tutor.py"
                    ]
                </py-config>


                

                <script type="py">

                    
                    import matplotlib.pyplot as plt
                    import matplotlib.tri as tri
                    import numpy as np
                    import pandas as pd
                    from pyodide.http import open_url
                    from js import console
                    from mpl_toolkits.axes_grid1 import make_axes_locatable
                    import json

                 
                    ###########################################


                    url1 = "https://ksmart1.github.io/MachineLearning/vic_ids_train.csv"
                    vic_ids_train = pd.read_csv(open_url(url1))
                    vic_ids_train_np = vic_ids_train.to_numpy()

                    url2 = "https://ksmart1.github.io/MachineLearning/vic_conditions_train.csv"
                    vic_conditions_train = pd.read_csv(open_url(url2))
                    vic_conditions_train_np = vic_conditions_train.to_numpy()

                    #########################################################################################################

                    url3 = "https://ksmart1.github.io/MachineLearning/images_dataset_chunk_1.csv"
                    url4 = "https://ksmart1.github.io/MachineLearning/images_dataset_chunk_2.csv"
                    url5 = "https://ksmart1.github.io/MachineLearning/images_dataset_chunk_3.csv"
                    url6 = "https://ksmart1.github.io/MachineLearning/images_dataset_chunk_4.csv"
                    url7 = "https://ksmart1.github.io/MachineLearning/images_dataset_chunk_5.csv"
                    url8 = "https://ksmart1.github.io/MachineLearning/images_dataset_chunk_6.csv"

                    image_datasets = []
                    
                    for i in range(3,9):
                        url_variable = globals()["url" + str(i)]
                        df_chunk = pd.read_csv(open_url(url_variable))
                        image_datasets.append(df_chunk)

                    images_np_train = pd.concat(image_datasets)
                    images_np_train = images_np_train.to_numpy()
            
                    ######################################################

                    def euclidean_distance(v1, v2):
                        return np.sqrt( np.sum(   (v1 - v2)**2   )   )

              
                    ######################################################

                    def predict(test_x):
                        num_folds = int(Element('numfolds').element.value)
                    
                        distances = [euclidean_distance(test_x, x) for x in vic_conditions_train_np]
                        k = num_folds
                        k_neighbor_indices = np.argsort(distances)[:k]
                        selected_imgs_to_avg = [images_np_train[i].reshape((200, 350, 3)) for i in k_neighbor_indices]
                    
                        avg_gen_img = np.mean(np.array(selected_imgs_to_avg), axis=0)
                        avg_gen_img = avg_gen_img.astype(int)
                        return avg_gen_img

                    ##################################################
                    
                    def get_np_conditions_vector():
                        # Load scaler parameters from JSON file
                        scaler_params_url = "https://raw.githubusercontent.com/ksmart1/MachineLearning/main/scaling_params.json"
                        scaling_params_response = open_url(scaler_params_url)
                        scaling_params_data = scaling_params_response.read()
                        scaling_params = json.loads(scaling_params_data)
                    
                        # Extract min and max values from scaling_params
                        min_values = scaling_params['min_values']
                        max_values = scaling_params['max_values']

                        # Dictionary for encoding categorical inputs
                        orientation_map = {'left': 0, 'right': 1}
                        color_map = {'red': 0, 'white': 1, 'blue': 2, 'green': 3, 'silver': 4, 'gray': 5, 'tan': 6, 'burgandy': 7, 'light blue': 8,
                                     'purple': 9, 'orange': 10, 'yellow': 11, 'gold': 12, 'auburn': 13, 'brown': 14, 'black': 15}
                        vehicle_map = {'car': 0, 'truck': 1, 'van': 2}
                        configuration_map = {'2-door': 0, '4-door': 1, 'sliding': 2, 'convertible': 3}
                        wheel_size_map = {'small': 0, 'average': 1, 'above': 2}
                        ride_height_map = {'lowered': 0, 'stock': 1, 'lifted': 2}
                        windows_map = {'none': 0, 'tint': 1}
                    
                        # Processing user input
                        c1 = orientation_map.get(Element('testInput1').element.value.lower(), 0)
                        c2 = color_map.get(Element('testInput2').element.value.lower(), 0)  
                        c3 = vehicle_map.get(Element('testInput3').element.value.lower(), 0)
                        c4 = configuration_map.get(Element('testInput4').element.value.lower(), 0)
                        c5 = wheel_size_map.get(Element('testInput5').element.value.lower(), 0)
                        c6 = ride_height_map.get(Element('testInput6').element.value.lower(), 0)
                        c7 = windows_map.get(Element('testInput7').element.value.lower(), 0)
                    
                        # Scale the numerical inputs using the loaded scaler parameters
                        c2 = (c2 - min_values[1]) / (max_values[1] - min_values[1])
                    
                        conditions_list = [c1, c2, c3, c4, c5, c6, c7]
                        np_conditions_list = np.array(conditions_list)
                        np_conditions_list = np.expand_dims(np_conditions_list, axis=0)
                    
                        return np_conditions_list



                    ##################################################

                    def my_gen_function():
                    
                        test_x = get_np_conditions_vector()

                        #####################################################
                        text1 = str(vic_conditions_train_np.shape)
                        text2 = str(vic_ids_train_np.shape)
                        text3 = str(images_np_train.shape)
                        text4 = str(test_x.shape)
                        text = text1 + text2 + text3 + text4
                        Element('test-output').element.innerText =  text   
                        #####################################################
                        
                        generated_img = predict( test_x )
                    
                        #####################################################          
                        test_x = test_x.astype(int)
                        str_conditions = np.array2string(test_x, precision=0, separator=',', suppress_small=True)
                        str_conditions = str_conditions.replace(" ","")
                        str_conditions = str_conditions.replace("[","")
                        str_conditions = str_conditions.replace("]","")
                        #####################################################

                        fig1, ax1 = plt.subplots()
                        plt.imshow(generated_img)                                     ##, cmap='summer')
                        plt.colorbar(label="Colorbar", orientation="vertical")
                        ax1.set_title(str_conditions)

                        ## Element('mpl').element.innerText = ""        ## use this to not accumulate imgs
                        display(fig1, target="mpl")
                    
                        #####################################################

                        ## fig, ax = plt.subplots(1,2)
                        ## ax[0].imshow(generated_img)
                        ## ax[1].imshow(generated_img)
                        ## ax[0].set_title("Gen: " + str_conditions)
                        ## ax[1].set_title("real")
                        ## Element('mpl').element.innerText = ""        ## use this to not accumulate imgs
                        ## display(fig, target="mpl")
   
                </script>
         
        </section>


        
    </body>
</html>

